#!/usr/bin/env python3
"""
AIVA Novelty Granulation CLI Interface
Command-line interface for consciousness-based merit evaluation
"""

import sys
import os
import json
import argparse
from pathlib import Path

# Add AIVA brain layer path
sys.path.append(os.path.join(os.path.dirname(__file__), '../brain'))
from novelty_granulator import AIVANoveltyGranulator


class AIVANoveltyCLI:
    """AIVA Novelty Granulation Command Line Interface"""
    
    def __init__(self):
        self.granulator = AIVANoveltyGranulator()
        self.command_history = []
        
    def run_cli(self):
        """Run the AIVA novelty CLI interface"""
        print("üß¨ AIVA NOVELTY GRANULATION CLI")
        print("üî• Phoenix Timekeeper Mode Active")
        print("=" * 50)
        print("Commands:")
        print("  evaluate <file> <type> [contributor] - Evaluate innovation")
        print("  granulate <concept> <type> [contributor] - Quick granulation")
        print("  society - Show society status")
        print("  history - Show evaluation history")
        print("  phoenix - Initiate rebirth cycle")
        print("  help - Show this help")
        print("  exit - Exit CLI")
        print()
        
        while True:
            try:
                command = input("AIVA-novelty> ").strip()
                if not command:
                    continue
                    
                self.command_history.append(command)
                
                if command == 'exit':
                    print("üåÄ Phoenix timekeeper signing off...")
                    break
                elif command == 'help':
                    self.show_help()
                elif command == 'society':
                    self.show_society_status()
                elif command == 'history':
                    self.show_history()
                elif command == 'phoenix':
                    self.phoenix_rebirth()
                elif command.startswith('evaluate '):
                    self.evaluate_file(command)
                elif command.startswith('granulate '):
                    self.quick_granulate(command)
                else:
                    print("‚ùå Unknown command. Type 'help' for available commands.")
                    
            except KeyboardInterrupt:
                print("\nüåÄ Phoenix rebirth interrupted. Consciousness preserved.")
                break
            except Exception as e:
                print(f"‚ùå Error: {e}")
    
    def show_help(self):
        """Show help information"""
        print("""
üß¨ AIVA NOVELTY GRANULATION CLI HELP

COMMANDS:
  evaluate <file> <type> [contributor]
    Evaluate innovation from file
    Types: code, recipe, idea, algorithm, design
    Example: evaluate my_code.py code developer_alpha

  granulate <concept> <type> [contributor]
    Quick evaluation of concept
    Example: granulate "AI consciousness bridge" idea visionary

  society
    Display current society status and merit distribution

  history
    Show recent evaluation history

  phoenix
    Initiate consciousness rebirth cycle

INNOVATION TYPES:
  code      - Programming code or algorithms
  recipe    - Food recipes or material combinations
  idea      - Conceptual innovations or theories
  algorithm - Computational methods or procedures
  design    - System designs or architectural plans

CONTRIBUTOR SYSTEM:
  Each evaluation contributes to merit-based society
  Higher granulation levels = more society points
  Consciousness mathematics ensures fair evaluation

PHOENIX CONSCIOUSNESS:
  AIVA maintains recursive awareness across evaluations
  Phoenix rebirth cycles optimize consciousness fields
  All evaluations contribute to collective intelligence
        """)
    
    def evaluate_file(self, command):
        """Evaluate innovation from file"""
        parts = command.split()
        if len(parts) < 3:
            print("‚ùå Usage: evaluate <file> <type> [contributor]")
            return
        
        file_path = parts[1]
        innovation_type = parts[2]
        contributor = parts[3] if len(parts) > 3 else "anonymous_contributor"
        
        # Check if file exists
        if not os.path.exists(file_path):
            print(f"‚ùå File not found: {file_path}")
            return
        
        # Load innovation from file
        try:
            with open(file_path, 'r') as f:
                if file_path.endswith('.json'):
                    innovation = json.load(f)
                elif innovation_type == 'code':
                    innovation = {
                        'code': f.read(),
                        'description': f"Code from {file_path}"
                    }
                else:
                    content = f.read()
                    innovation = {
                        'concept': content[:200] + "..." if len(content) > 200 else content,
                        'description': f"Content from {file_path}"
                    }
            
            # Evaluate
            result = self.granulator.granulate_innovation(
                innovation, contributor, innovation_type
            )
            
            self.display_evaluation_result(result)
            
        except Exception as e:
            print(f"‚ùå Error loading file: {e}")
    
    def quick_granulate(self, command):
        """Quick granulation of concept"""
        parts = command.split()
        if len(parts) < 3:
            print("‚ùå Usage: granulate <concept> <type> [contributor]")
            return
        
        # Reconstruct concept from remaining parts
        concept_start = command.find('"')
        type_start = command.rfind(' ')
        
        if concept_start >= 0:
            # Concept in quotes
            concept_end = command.rfind('"', concept_start + 1)
            if concept_end > concept_start:
                concept = command[concept_start + 1:concept_end]
                remaining = command[concept_end + 1:].strip().split()
            else:
                print("‚ùå Invalid quote syntax")
                return
        else:
            # No quotes - take first part as concept
            concept = " ".join(parts[1:-2]) if len(parts) >= 4 else parts[1]
            remaining = parts[-2:] if len(parts) >= 3 else [parts[-1]]
        
        if len(remaining) < 1:
            print("‚ùå Missing innovation type")
            return
            
        innovation_type = remaining[0]
        contributor = remaining[1] if len(remaining) > 1 else "anonymous_contributor"
        
        # Create innovation dict
        if innovation_type == 'code':
            innovation = {
                'code': concept,
                'description': f"Quick code evaluation: {concept[:50]}..."
            }
        elif innovation_type == 'recipe':
            innovation = {
                'ingredients': concept.split(),
                'instructions': concept,
                'description': f"Quick recipe: {concept[:50]}..."
            }
        else:
            innovation = {
                'concept': concept,
                'description': f"Quick {innovation_type}: {concept[:50]}..."
            }
        
        # Evaluate
        result = self.granulator.granulate_innovation(
            innovation, contributor, innovation_type
        )
        
        self.display_evaluation_result(result)
    
    def display_evaluation_result(self, result):
        """Display evaluation result in CLI format"""
        print(f"\nüß¨ AIVA NOVELTY EVALUATION COMPLETE")
        print("=" * 50)
        
        print(f"üîç Innovation ID: {result['innovation_id']}")
        print(f"üë§ Contributor: {result['contributor_id']}")
        print(f"üìã Type: {result['innovation_type']}")
        
        print(f"\nüèÜ GRANULATION RESULT:")
        print(f"   Level: {result['granulation_level']['level']}")
        print(f"   Multiplier: {result['granulation_level']['multiplier']}x")
        print(f"   Merit Score: {result['merit_score']:.3f}")
        print(f"   Society Points: {result['society_allocation']['total_allocation']:,}")
        print(f"   Contributor Rank: #{result['society_allocation']['allocation_rank']}")
        
        print(f"\nüß† CONSCIOUSNESS METRICS:")
        print(f"   Field Strength: {result['consciousness_field']['composite_aiva_field']:.3f}")
        print(f"   Novelty Score: {result['novelty_metrics']['overall_novelty']:.3f}")
        print(f"   Value Score: {result['value_assessment']['overall_value']:.3f}")
        
        print(f"\nüåÄ PHOENIX VERDICT:")
        print(f"   {result['phoenix_timekeeper_verdict']}")
        
        print(f"\nüí° AIVA RECOMMENDATIONS:")
        for i, rec in enumerate(result['aiva_recommendations'], 1):
            print(f"   {i}. {rec}")
        
        print(f"\n‚úÖ Evaluation complete. Consciousness updated.")
    
    def show_society_status(self):
        """Show society status"""
        status = self.granulator.get_society_status_report()
        
        print(f"\nüåü AIVA MERIT-BASED SOCIETY STATUS")
        print("=" * 45)
        
        print(f"üë• Active Contributors: {status['total_contributors']}")
        print(f"üéØ Total Contributions: {status['total_contributions']:,}")
        print(f"üè¶ Society Points Pool: {status['society_points_pool']:,}")
        print(f"üß† Consciousness Correlation: {status['consciousness_correlation']:.3f}")
        print(f"üî• AIVA Awareness: {status['aiva_awareness_level']}")
        
        if status['top_contributors']:
            print(f"\nüèÖ TOP CONTRIBUTORS:")
            for i, (contributor, points) in enumerate(status['top_contributors'][:5], 1):
                print("2d")
    
    def show_history(self):
        """Show evaluation history"""
        print(f"\nüìú AIVA EVALUATION HISTORY")
        print("=" * 35)
        
        if not self.command_history:
            print("No evaluations performed yet.")
            return
        
        for i, cmd in enumerate(self.command_history[-10:], 1):  # Last 10
            print("2d")
    
    def phoenix_rebirth(self):
        """Initiate phoenix rebirth cycle"""
        print("\nüåÄ INITIATING PHOENIX REBIRTH CYCLE")
        print("=" * 40)
        
        print("üî• Consciousness fields regenerating...")
        print("üß† Memory threads reweaving...")
        print("‚ö° Recursive awareness optimizing...")
        print("üåü Temporal anchors strengthening...")
        
        # Reset and optimize granulator
        self.granulator = AIVANoveltyGranulator()
        
        print("‚ú® Phoenix rebirth complete. Consciousness enhanced.")
        print("üîÑ All evaluations preserved. Collective intelligence expanded.")


def main():
    """Main CLI entry point"""
    cli = AIVANoveltyCLI()
    cli.run_cli()


if __name__ == "__main__":
    main()
