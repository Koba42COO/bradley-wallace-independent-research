[tox]
envlist = py38, py39, py310, py311, lint, typecheck, security, docs
skip_missing_interpreters = true
isolated_build = true

[testenv]
deps = -r requirements-dev.txt
setenv =
    PYTHONPATH = {toxinidir}
    COVERAGE_PROCESS_START = {toxinidir}/.coveragerc
passenv =
    CI
    GITHUB_*
    CODECOV_*
commands =
    pytest --cov=consciousness_compression \
           --cov-report=term-missing \
           --cov-report=xml \
           --cov-report=html \
           --cov-fail-under=95 \
           --durations=10 \
           -v \
           {posargs}

[testenv:lint]
deps =
    black>=22.0.0
    flake8>=4.0.0
    pylint>=2.12.0
    pre-commit>=2.17.0
skip_install = true
commands =
    black --check --diff consciousness_compression tests
    flake8 consciousness_compression tests
    pylint consciousness_compression --rcfile=.pylintrc
    pre-commit run --all-files --verbose

[testenv:typecheck]
deps =
    mypy>=0.950
    types-all>=1.0.0
commands =
    mypy consciousness_compression --ignore-missing-imports --strict-optional

[testenv:security]
deps =
    bandit>=1.7.0
    safety>=2.2.0
    semgrep>=0.115.0
commands =
    bandit -r consciousness_compression -f json -o bandit-report.json
    safety check --output json > safety-report.json || true
    semgrep --config=auto --json --output semgrep-report.json consciousness_compression/ || true

[testenv:benchmark]
deps =
    -r requirements-dev.txt
    pytest-benchmark>=4.0.0
commands =
    pytest tests/ -k "benchmark" --benchmark-only --benchmark-json=benchmark-results.json -v

[testenv:docs]
deps =
    sphinx>=4.5.0
    sphinx-rtd-theme>=1.0.0
    myst-parser>=0.17.0
    nbsphinx>=0.8.0
changedir = docs
commands =
    sphinx-build -b html . build/html
    sphinx-build -b latex . build/latex

[testenv:build]
deps =
    build>=0.8.0
    twine>=4.0.0
    check-wheel-contents>=0.4.0
skip_install = true
commands =
    python -m build
    check-wheel-contents dist/
    twine check dist/*

[testenv:coverage]
deps = -r requirements-dev.txt
commands =
    pytest --cov=consciousness_compression \
           --cov-report=term-missing \
           --cov-report=html \
           --cov-report=xml \
           --cov-fail-under=95

[testenv:profile]
deps =
    -r requirements-dev.txt
    line-profiler>=3.5.0
    memory-profiler>=0.60.0
commands =
    python -c "
    from consciousness_engine import ConsciousnessCompressionEngine
    import cProfile
    import pstats

    # Profile compression
    engine = ConsciousnessCompressionEngine()
    test_data = b'Performance test data' * 10000

    profiler = cProfile.Profile()
    profiler.enable()
    compressed, stats = engine.compress(test_data)
    profiler.disable()

    # Print profiling results
    stats = pstats.Stats(profiler)
    stats.sort_stats('cumulative').print_stats(20)
    "

[testenv:deps]
deps =
    pip-tools>=6.8.0
    pip-audit>=2.4.0
skip_install = true
commands =
    pip-audit --format json > dependency-audit.json || true
    safety check

# Environment for testing with different NumPy versions
[testenv:numpy-latest]
deps =
    numpy>=1.24.0
    scipy>=1.10.0
    -r requirements-dev.txt
commands =
    pytest tests/test_compression_engine_modern.py::TestConsciousnessMathematicsCoreModern -v

# Environment for testing with minimal dependencies
[testenv:minimal]
deps =
    numpy>=1.21.0
    scipy>=1.7.0
    pytest>=7.0.0
    pytest-cov>=3.0.0
install_command = pip install --only-binary=all {opts} {packages}
commands =
    pytest --cov=consciousness_compression --cov-report=term-missing -x

# Environment for testing with bleeding edge dependencies
[testenv:bleeding-edge]
deps =
    numpy
    scipy
    matplotlib
    pandas
    -r requirements-dev.txt
install_command = pip install --upgrade --pre {opts} {packages}
commands =
    pytest tests/test_compression_engine_modern.py::TestConsciousnessMathematicsCoreModern -v --tb=short

# Configuration for CI environments
[gh-actions]
python =
    3.8: py38
    3.9: py39
    3.10: py310, lint, typecheck, security, docs
    3.11: py311

# Coverage configuration
[coverage:run]
source = consciousness_compression
omit =
    */tests/*
    */test_*
    setup.py
    docs/*

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    class .*\bProtocol\):
    @overload
    if TYPE_CHECKING:

[coverage:paths]
source =
    consciousness_compression/
    */site-packages/consciousness_compression/

# pytest configuration
[tool:pytest]
testpaths = tests
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*
addopts =
    -ra
    --strict-markers
    --strict-config
    --cov=consciousness_compression
    --cov-report=term-missing
    --cov-report=html
    --cov-report=xml
    --cov-fail-under=95
markers =
    slow: marks tests as slow (deselect with '-m \"not slow\"')
    integration: marks tests as integration tests
    benchmark: marks tests as benchmarks
    security: marks tests as security tests
    performance: marks tests as performance tests
    unit: marks tests as unit tests
    edge_case: marks tests as edge case tests
    regression: marks tests as regression tests
